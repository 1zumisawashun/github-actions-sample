on:
  pull_request:
    types: [ready_for_review]

name: Slack Notification When PR become ready for review

jobs:
  add-assignees:
    runs-on: ubuntu-latest
    if: ${{ ! contains(fromJson('["renovate[bot]", "dependabot[bot]"]'), github.actor) }}
    permissions:
      pull-requests: write
    steps:
      # ファイルを分割する場合はcheckoutしてファイルを取得しないと失敗する
      - uses: actions/checkout@v3
      - uses: actions/github-script@v7
        with:
          # @see https://docs.github.com/ja/rest/issues/assignees?apiVersion=2022-11-28#add-assignees-to-an-issue
          script: |
            const script = require('./.github/scripts/add-assignees.js')
            await script({github, context, core})

  create-comment:
    runs-on: ubuntu-latest
    if: ${{ ! contains(fromJson('["renovate[bot]", "dependabot[bot]"]'), github.actor) }}
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/github-script@v7
        with:
          # @see https://docs.github.com/ja/rest/issues/comments?apiVersion=2022-11-28#create-an-issue-comment
          script: |
            const script = require('./.github/scripts/create-comment.js')
            await script({github, context, core})

  write-summary:
    runs-on: ubuntu-latest
    steps:
      # ファイルを分割する場合はcheckoutしてファイルを取得しないと失敗する
      - uses: actions/checkout@v3
      - uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/write-summary.js')
            await script({github, context, core})

  slack-notification:
    name: Slack Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.2.0
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}
          SLACK_LINK_NAMES: true # メッセージ内でのメンションを有効にする
          SLACK_MESSAGE: |
            レビューをお願いします🙏 @engineers
            <${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}>
          SLACK_USERNAME: "レビューお願いします！Bot"
          MSG_MINIMAL: true # メッセージだけを通知文にする
