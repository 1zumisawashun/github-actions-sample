on:
  pull_request:
    types: [ready_for_review]

name: Slack Notification When PR become ready for review

jobs:
  add-assignees:
    runs-on: ubuntu-latest
    if: ${{ ! contains(fromJson('["renovate[bot]", "dependabot[bot]"]'), github.actor) }}
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
        with:
          sparse-checkout: .github/scripts/add-assignees.js
      - uses: actions/github-script@v7
        with:
          # @see https://docs.github.com/ja/rest/issues/assignees?apiVersion=2022-11-28#add-assignees-to-an-issue
          # @description 引数のgithub, context, coreは、actions/github-script独自のpropsなのでgithub actions contextと異なる
          # @description github-scriptのreadmeにも記載がある（[詳細](https://github.com/actions/github-script)）
          # @description 例えばcontextは[こちら](https://github.com/actions/toolkit/blob/master/packages/github/src/context.ts)のファイルで定義されている
          # @description 例えばgithub.restが取れるようになるので、それを使ってAPIを叩く
          script: |
            const script = require('./.github/scripts/add-assignees.js')
            await script({github, context, core})

  create-comment:
    runs-on: ubuntu-latest
    if: ${{ ! contains(fromJson('["renovate[bot]", "dependabot[bot]"]'), github.actor) }}
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
        with:
          sparse-checkout: .github/scripts/create-comment.js
      - uses: actions/github-script@v7
        with:
          # @see https://docs.github.com/ja/rest/issues/comments?apiVersion=2022-11-28#create-an-issue-comment
          script: |
            const script = require('./.github/scripts/create-comment.js')
            await script({github, context, core})

  write-summary:
    runs-on: ubuntu-latest
    if: ${{ ! contains(fromJson('["renovate[bot]", "dependabot[bot]"]'), github.actor) }}
    steps:
      - uses: actions/checkout@v3
        with:
          sparse-checkout: .github/scripts/write-summary.js
      - uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/write-summary.js')
            await script({github, context, core})

  slack-notification:
    runs-on: ubuntu-latest
    if: ${{ ! contains(fromJson('["renovate[bot]", "dependabot[bot]"]'), github.actor) }}
    steps:
      - uses: actions/checkout@v2.2.0
      - uses: rtCamp/action-slack-notify@v2
        # https://book.st-hakky.com/hakky/github-actions-result-notification-to-slack/
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}
          SLACK_MESSAGE: |
            レビューをお願いします🙏
            <${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}> by ${{ github.event.pull_request.user.login }}
